# World Time Tool 要件定義書（実装済み）

- ドキュメント種別: 要件定義（現状実装ベース）
- 対象: `wt-tool` 内のサイト（Next.js アプリ）
- 版: v17 相当
- 作成日: 2025-08-29

## 1. 目的・概要
複数のタイムゾーンに属する都市の時刻を同時表示し、会議時間候補（ブロック）を複数パターンとして作成・比較・共有用にコピーできるツールを提供する。

## 2. 用語定義
- 都市: タイムゾーンに紐づく地点。`tzId`（例: `Asia/Tokyo`）を持つ。
- 候補ブロック（候補）: 候補日時の比較用コンテナ。各候補は独立した日付（ローカル 0 時起点）と選択範囲を持つ。
- 粒度: グリッドの時間間隔（15/30/60 分）。

## 3. 対象範囲（スコープ）
- 本要件は現状の UI/機能の挙動に限定する。将来の拡張や未使用コード（例: Prisma モデル）は対象外。

## 4. 画面構成
- ヘッダー
  - タイトル表示: `World Time Tool v1`。
- 3 カラムレイアウト
  - 左: 都市リスト（追加/並べ替え/削除）。
  - 中央: 候補ブロック一覧（複数候補の時間グリッド）。
  - 右: 設定パネル（粒度切替）。

## 5. 機能要件
### 5.1 都市管理（左パネル）
- 都市追加
  - 「都市を追加」ボタンで検索モーダルを開く。
  - 検索は別名（`aliases`）、都市名（日英）、国名（日英）を対象。
  - 検索結果は最大 10 件表示。
  - 選択すると都市リストに追加。
- 現在地タイムゾーン検出
  - ブラウザの `Intl` から推定した TZ を、未追加の場合は上部に推薦カードとして提示。
  - データセットに同一 `tzId` があるときは代表都市名で表示、ない場合は `tzId` の末尾をラベルとして表示。
  - 「追加」ボタンで都市リストへ追加。
- 並べ替え
  - 都市カードをドラッグ&ドロップで並べ替え可能。
- 削除
  - 各都市行の削除ボタンで除去。
- 表示
  - 都市名・国名、現在時刻（秒まで）、日付、省略形式の UTC オフセット（例: `UTC+09:00`）。
- 制約
  - 同一 `id` の重複追加は不可。
  - 都市データは `public/data/city-timezones.json` に依存。
  - 都市リストはローカルに永続化（ストレージキー: `wt-cities`）。

### 5.2 候補ブロック（中央パネル）
- 候補の生成/削除
  - 初期状態で候補が 0 件の場合、自動で 1 件（`候補1`）を生成（現在のビュー範囲と選択状態を引き継ぎ）。
  - 画面下部の「＋ 候補を追加（最大5）」で直前の候補を複製して追加（最大 5 件）。
  - 各候補ヘッダーの「候補を削除」でその候補を削除（残数に応じ `候補N` を再採番）。
- 日付操作（各候補）
  - 日付ピッカーで日付を選択。基準は「一番上の都市のローカル 0 時」。
  - 「前日」「翌日」ボタンで 1 日単位に移動。
  - 週インジケータ（日〜土）を表示。対象曜日クリックでその日のローカル 0 時へジャンプ。
- グリッド表示
  - 行: 都市。列: 時間スロット。
  - 粒度: 15/30/60 分から選択（右パネルのグローバル設定に従う）。
  - 1 時間幅はコンテナ幅から自動計算（約 24〜160px/時間にクランプ）。
  - 0 時セルは「M月d日（曜）」を自動スケール表示。
  - 時間帯の背景色分け（深夜/早朝/日中/夕方〜夜）。
  - 垂直の「現在」ラインを表示（可視範囲内のみ、30 秒ごと更新）。
- 選択操作（各候補）
  - マウスドラッグで範囲選択（開始/終了ハンドルで端点調整可能）。
  - 複数行にまたがる統一ハイライト（上下/左右のエッジを強調）。
- 出力
  - 各候補の下に、選択範囲の各都市時刻を日本語でまとめて表示。
  - 「全候補の時間をコピー」ボタンで全候補の出力テキストをクリップボードへコピー。
  - 書式: 開始は `M月d日(曜) HH:mm`、同日内の終了は `HH:mm`、日跨ぎの終了は `M月d日(曜) HH:mm`。
  - 都市ラベルが「現在地」の場合、可能な範囲で `tzId` の末尾等により代表都市名へ置換して出力。
- 制約
  - 各候補の表示日数は 1 日相当（`days=1`）。
  - 候補数は最大 5 件。

### 5.3 設定（右パネル）
- 粒度切替
  - 15/30/60 分のいずれかを選択（全候補に適用）。
  - 永続化（ストレージキー: `wt-view`）。

### 5.4 URL パラメータ読込（自動設定）
- 対応パラメータ
  - `from`: ISO8601 UTC。選択範囲の開始。
  - `to`: ISO8601 UTC。選択範囲の終了（半開区間相当で内部では終了スロット+1として扱う）。
  - `cities`: 追加する都市 ID のカンマ区切り。
- 挙動
  - `cities` が指定され、未追加の都市があればデータセットから補完して自動追加。
  - `from`/`to` が有効な場合、先頭都市のローカル 0 時にビューを合わせ、粒度に基づくスロット単位で開始/終了インデックスを算出して選択状態を反映。
  - 読込は初期化後・一定遅延後に再適用し、都市の非同期追加にも追従。
- 備考
  - 現状、共有リンクの生成 UI は未提供（読込のみ対応）。

## 6. 非機能要件
- 表示
  - Tailwind CSS によるレスポンシブ調整。時間グリッドは横スクロール可能。
- パフォーマンス
  - リサイズ監視により 1 時間幅を自動再計算。
  - Luxon によるタイムゾーン/サマータイム安全な時刻計算。
- 永続化
  - Zustand + `persist` によりローカルストレージ保存。
  - ストレージキー: `wt-cities`（都市）、`wt-view`（粒度/範囲）、`wt-blocks`（候補）。
- 依存技術
  - 都市データは同梱 JSON に依存し、外部 API には依存しない。

## 7. 既知の制約・未対応

- 候補単位での粒度設定は不可（粒度はグローバル設定）。
- 固定 1 日表）。

## 8. 初期状態・デフォルト
- 粒度: 60 分。
- ビュー範囲: 現在日の 0:00（UTC）起点、1 日相当。
- 初回アクセス時は都市リストは空。現在地タイムゾーンが候補として表示される。
- 候補が 0 件の場合、自動的に 1 件作成。

## 9. エラーハンドリング・例外
- 都市データ読込失敗時は検索モーダルでメッセージ表示し、処理を継続（現在地検出は `tzId` 末尾名でフォールバック）。
- クリップボード書込は失敗しても UI エラーは出さず黙殺（可能な範囲で書込）。

## 10. 受け入れ基準（抜粋）
- 都市を 2 件以上追加すると、各候補のグリッドに両都市の行が表示される。
- 候補の選択範囲をドラッグで設定すると、全都市行に統一された選択ハイライトが表示される。
- 右パネルで粒度を切替えると、全候補のグリッドが該当粒度に再構成される。
- 「全候補の時間をコピー」で、全候補・全都市の日本語書式テキストがコピーできる。
- `?cities=tokyo,london&from=...&to=...` を付けてアクセスすると、都市が自動追加され、該当範囲が選択される。

---
本書は実装ソースの挙動をもとに作成した現状要件である。仕様変更時は本書の更新を行うこと。
